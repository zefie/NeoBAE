BAE_BUILT_IN_PATCHES	:= 1
BAE_API			:= SDL2
BUILD_GUI   	:= 1
WINDOWS 		:= 1
ifneq ($(NOAUTO),1)
ENABLE_MIDI_HW	:= 1
endif
include inc/Makefile.common
TARGET_BIN		:= $(TARGET_NAME).exe
SOURCE_DIR = $(CURDIR)

ifeq ($(BITS),32)
	CROSS := i686-w64-mingw32-
else
	CROSS := x86_64-w64-mingw32-
endif

ARCH		:= -static
CC			:= $(CROSS)gcc
CXX			:= $(CROSS)g++
# Use C++ linker if we have any C++ sources
ifneq ($(filter %.cpp,$(SRC) $(SRC_BIN)),)
LD			:= $(CXX)
else
LD			:= $(CC)
endif
AR      	:= $(CROSS)ar
STRIP      	:= $(CROSS)strip
DLLTOOL		:= $(CROSS)dlltool
WINDRES		:= $(CROSS)windres

OPTI            := -O2 -fPIC
ifeq ($(LDEBUG),1)
    OPTI := -g -O0 -ggdb3 -fPIC
endif
CFLAGS  	:= $(ARCH) $(OPTI) $(INC_PATH) -D_THREAD_SAFE -DEMBED_FONT_TTF -Wno-unused-value



ifneq ($(ENABLE_MIDI_HW),)
	# WinMM MIDI HW Support
	CFLAGS += -D__WINDOWS_MM__ 
endif

ifneq ($(BAE_FLAGS),)
	CFLAGS	+= $(BAE_FLAGS)
endif

include inc/Makefile.versioning
CFLAGS		+= -D_VERSION=\""$(VERSION)"\"

CXXFLAGS 	:= $(CFLAGS)
LDFLAGS		:= $(ARCH) $(OPTI)


ifneq ($(BAE_LD_FLAGS),)
	LDFLAGS += $(BAE_LD_FLAGS)
endif

ifneq ($(LDEBUG),1)
	LDFLAGS += -s
endif
ifeq ($(BITS),32)
CFLAGS  += -I../windeps/SDL2-2.32.8/i686-w64-mingw32/include -I../windeps/SDL2-2.32.8/i686-w64-mingw32/include/SDL2 -I../windeps/SDL2_ttf-2.24.0/i686-w64-mingw32/include
CXXFLAGS  += -I../windeps/SDL2-2.32.8/i686-w64-mingw32/include -I../windeps/SDL2-2.32.8/i686-w64-mingw32/include/SDL2 -I../windeps/SDL2_ttf-2.24.0/i686-w64-mingw32/include
LDFLAGS += -L../windeps/SDL2-2.32.8/i686-w64-mingw32/lib -L../windeps/SDL2_ttf-2.24.0/i686-w64-mingw32/lib
else
CFLAGS  += -I../windeps/SDL2-2.32.8/x86_64-w64-mingw32/include -I../windeps/SDL2-2.32.8/x86_64-w64-mingw32/include/SDL2 -I../windeps/SDL2_ttf-2.24.0/x86_64-w64-mingw32/include
CXXFLAGS  += -I../windeps/SDL2-2.32.8/x86_64-w64-mingw32/include -I../windeps/SDL2-2.32.8/x86_64-w64-mingw32/include/SDL2 -I../windeps/SDL2_ttf-2.24.0/x86_64-w64-mingw32/include
LDFLAGS += -L../windeps/SDL2-2.32.8/x86_64-w64-mingw32/lib -L../windeps/SDL2_ttf-2.24.0/x86_64-w64-mingw32/lib
endif

LIBS = \
	-lmingw32 \
	-lSDL2main \
	-lSDL2 \
	-lSDL2_ttf \
	-lusp10 \
	-lrpcrt4 \
	-lsetupapi \
	-lcfgmgr32 \
	-lversion \
	-limm32 \
	-lwinmm \
	-lole32 \
	-loleaut32 \
	-ladvapi32 \
	-luser32 \
	-lgdi32 \
	-lshell32 \
	-lshlwapi \
	-ldxguid \
	-ldsound \
	-luuid \
	-lkernel32 \
	-lcomdlg32 \
	-lwinspool \
	-lwinpthread \
	-lodbc32 \
	-lodbccp32 \
	-lz

ifneq ($(BAE_LIBS),)
	LIBS += $(BAE_LIBS)
endif	

all: $(TARGET_LIB).a ${TARGET_LIB}.dll $(TARGET_BIN)

$(TARGET_LIB).a: $(OBJ)
	@mkdir -p $(TARGET_OUT)
	$(AR) rcs $(TARGET_OUT)$(TARGET_LIB).a $(OBJ)

$(TARGET_LIB).dll: ${OBJ}
	@mkdir -p $(TARGET_OUT)
	@$(DLLTOOL) --export-all --export-all-symbols -e $(OBJ_DIR)exports.o -z $(OBJ_DIR)$(TARGET_LIB).def2 $(OBJ)
	@echo "EXPORTS" > $(OBJ_DIR)$(TARGET_LIB).def
	@cat $(OBJ_DIR)$(TARGET_LIB).def2 | grep "BAE" >> $(OBJ_DIR)$(TARGET_LIB).def
	@rm -f $(OBJ_DIR)$(TARGET_LIB).def2 $(OBJ_DIR)exports.o
	@$(DLLTOOL) -e $(OBJ_DIR)exports.o -d $(OBJ_DIR)$(TARGET_LIB).def -l $(TARGET_OUT)$(TARGET_LIB).lib $(OBJ)
	${LD} -shared $(LDFLAGS) ${OBJ} $(OBJ_DIR)exports.o -Wl,--subsystem,windows -o $(TARGET_OUT)${TARGET_LIB}.dll ${LIBS}
ifeq ($(USING_BASSMIDI),1)
ifeq ($(BITS),32)
	@$(shell cp src/thirdparty/bassmidi/libs/x86/bass*.dll* $(TARGET_OUT) 2>/dev/null || true)
else
	@$(shell cp src/thirdparty/bassmidi/libs/x86_64/bass*.dll* $(TARGET_OUT) 2>/dev/null || true)
endif
endif
ifeq ($(USING_FLUIDSYNTH),1)
ifeq ($(BITS),32)
	@$(shell cp ../windeps/FluidSynth/x86/lib/*.dll $(TARGET_OUT) 2>/dev/null || true)
else
	@$(shell cp ../windeps/FluidSynth/x86_64/lib/*.dll $(TARGET_OUT) 2>/dev/null || true)
endif
endif

$(TARGET_BIN): ${OBJ_BIN}
	@mkdir -p $(TARGET_OUT)/Banks
	$(${SOURCE_DIR}/src/banks/copy.sh $(TARGET_OUT)/Banks)
	@if [ -f src/gui/zefidi.rc ]; then \
		echo "Compiling resource file..."; \
		${WINDRES} src/gui/zefidi.rc $(OBJ_DIR)zefidi.o; \
		${LD} -o $(TARGET_OUT)${TARGET_BIN} ${LDFLAGS} ${OBJ_BIN} $(OBJ_DIR)zefidi.o -Wl,--subsystem,windows ${LIBS}; \
	else \
		${LD} -o $(TARGET_OUT)${TARGET_BIN} ${LDFLAGS} ${OBJ_BIN} -Wl,--subsystem,windows ${LIBS}; \
	fi

# Rules for compiling source files to object files
$(OBJ_DIR)%.o : %.cpp
	@echo @compile $<
	@mkdir -p $(OBJ_DIR)
	$(SILENT)${CXX} -c ${CXXFLAGS} $< -o $@

$(OBJ_DIR)%.o : %.c
	@echo @compile $<
	@mkdir -p $(OBJ_DIR)
	$(SILENT)${CC} -c ${CFLAGS} $< -o $@

clean:
	@rm -rf $(TARGET_OUT)
	@rm -rf $(OBJ_DIR)
	@rm -rf $(BUILD_DIR)
	@rm -rf $(TEST_OUT_DIR)
	@rm -f $(OBJ_DIR)minibae_gui.o
	@echo Cleaned!

# Generate rules for all unique source files (same approach as top-level Makefile)
ALL_SOURCES := $(sort $(SRC) $(SRC_BIN))
$(foreach src,$(ALL_SOURCES),$(eval $(call make_obj_rule,$(src))))

include inc/Makefile.tests
